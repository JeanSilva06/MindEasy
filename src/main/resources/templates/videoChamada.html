<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Videochamada – MindEasy</title>

  <!-- Ícones e Bootstrap -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../style/videoChamada.css">
  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  


  <!-- SDK do Jitsi -->
  <script src="https://meet.jit.si/external_api.js"></script>

</head>
<body>
  

  <!-- ===== SIDEBAR ===== -->
  <div class="sidebar">
    <div class="brand">MindEasy</div>
    <ul>
      <li><a href="calendario.html"><i class="fa-regular fa-calendar"></i> Agenda</a></li>
      <li><a href="perfilTerapeuta.html"><i class="fa-solid fa-user-doctor"></i> Terapeuta</a></li>
      <li><a href="menu.html"><i class="fa-regular fa-star"></i> Serviços</a></li>
      <li><a href="chat.html"><i class="fa-regular fa-comment"></i> Chat</a></li>
      <li><a href="dashboard.html"><i class="fa-solid fa-chart-line"></i>Dashboard</a></li>
    </ul>

    <div class="logout">
      <a class="d-block text-center text-danger fw-bold" href="cadastro.html">
        <i class="fa-solid fa-right-from-bracket"></i> Sair
      </a>
    </div>
  </div>

  <div id="sidebar-handle">&#x25B6;</div>

  <!-- ===== CONTEÚDO PRINCIPAL ===== -->
  <div class="main-container">

    <!-- Lista de Pacientes -->
    <div class="contacts-list" id="contactsList">
      <div class="contacts-header">Pacientes</div>

      <div class="contact" onclick="selecionarPaciente('João Silva')">
        <img src="https://via.placeholder.com/40" alt="Paciente">
        <div class="contact-info">
          <h4>João Silva</h4>
          <small>Online</small>
        </div>
      </div>

      <div class="contact" onclick="selecionarPaciente('Maria Oliveira')">
        <img src="https://via.placeholder.com/40" alt="Paciente">
        <div class="contact-info">
          <h4>Maria Oliveira</h4>
          <small>Offline</small>
        </div>
      </div>

      <div class="contact" onclick="selecionarPaciente('Carlos Souza')">
        <img src="https://via.placeholder.com/40" alt="Paciente">
        <div class="contact-info">
          <h4>Carlos Souza</h4>
          <small>Online</small>
        </div>
      </div>
    </div>

    <!-- Área da Videochamada -->
    <div class="video-container">
      <div class="video-header">
        <h2 id="tituloChamada">Selecione um paciente</h2>
        <button id="btnChamar" disabled onclick="iniciarChamada()">
          <i class="fa-solid fa-play"></i> Iniciar Chamada
        </button>
      </div>

      <div class="video-body" id="videoBody">
        <div id="meet">
          <div class="placeholder">
            <i class="fa-solid fa-video"></i>
            <p>Aguardando início da chamada...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== SCRIPT ===== -->
  <script>
    let pacienteSelecionado = null;

    function selecionarPaciente(nome) {
      pacienteSelecionado = nome;
      document.getElementById("tituloChamada").innerText = "Videochamada com " + nome;
      document.getElementById("btnChamar").disabled = false;

      // Remove destaque anterior
      document.querySelectorAll(".contact").forEach(c => c.style.background = "");
      event.currentTarget.style.background = "#eaf6ff";
    }

    function iniciarChamada() {
      if (!pacienteSelecionado) return;

      const domain = "meet.jit.si";
      const sala = "MindEasy_" + pacienteSelecionado.replace(/\s/g, "_");

      const options = {
        roomName: sala,
        width: "100%",
        height: "100%",
        parentNode: document.querySelector('#meet'),
        interfaceConfigOverwrite: {
          SHOW_JITSI_WATERMARK: false,
          SHOW_BRAND_WATERMARK: false,
          SHOW_POWERED_BY: false,
        },
        configOverwrite: { prejoinPageEnabled: true }
      };

      document.querySelector("#meet").innerHTML = "";
      new JitsiMeetExternalAPI(domain, options);
    }

    const sidebar = document.querySelector('.sidebar');
    const handle = document.getElementById('sidebar-handle');

    handle.addEventListener('mouseenter', () => {
      sidebar.classList.add('shown'); // abre a sidebar
    });

    sidebar.addEventListener('mouseleave', () => {
      sidebar.classList.remove('shown'); // fecha ao tirar o mouse
    }); 

    pacienteSelecionado = null;
    // Busca os pacientes via API (AGORA COM AUTENTICAÇÃO)
    async function carregarPacientes() {
      try {
        // 1. Pega o token que salvamos no login
        const token = localStorage.getItem('mindeasy_token');

        if (!token) {
            alert("Você não está logado. Redirecionando para o login.");
            window.location.href = 'cadastro.html'; // Manda de volta pro login
            return;
        }

        // 2. Adiciona o token no cabeçalho da requisição
        const response = await axios.get("http://localhost:8080/api/pacientes", {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        }); 
        
        const pacientes = response.data;
        const lista = document.getElementById("contactsList");

        lista.innerHTML = '<div class="contacts-header">Pacientes</div>'; // limpa a lista antes

        pacientes.forEach(p => {
          const div = document.createElement("div");
          div.classList.add("contact");
          div.onclick = () => selecionarPaciente(p.nome);

          div.innerHTML = `
            <img src="https://via.placeholder.com/40" alt="Paciente">
            <div class="contact-info">
              <h4>${p.nome}</h4>
              <small>${p.status === "online" ? "Online" : "Offline"}</small> 
            </div>
          `;
          // O "status" não existe no seu DTO, 
          // então vamos simplificar a linha acima:
          div.innerHTML = `
            <img src="https://via.placeholder.com/40" alt="Paciente">
            <div class="contact-info">
              <h4>${p.nome}</h4>
              <small>ID: ${p.id}</small>
            </div>
          `;


          lista.appendChild(div);
        });
      } catch (error) {
          console.error("Erro ao carregar pacientes:", error);
          if (error.response && (error.response.status === 401 || error.response.status === 403)) {
              alert("Sua sessão expirou. Faça o login novamente.");
              window.location.href = 'cadastro.html';
          }
        }
  }

    // Chama a função ao carregar a página
    window.onload = carregarPacientes;

  </script>

  <script src="../static/menu.js"></script>

</body>
</html>
